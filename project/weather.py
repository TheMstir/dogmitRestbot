import requests
import json
import datetime
import config
import telebot

# –§–∞–∏–ª –∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å—Å—ã–ª–∫—É


def get_weather_box(city):
    """
    –ü–æ –∑–∞–ø—Ä–æ—Å—É –≤—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Ç–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –ø–æ–≥–æ–¥–µ –≤ –≥–æ—Ä–æ–¥–µ, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç –æ—Ç–µ–ª—å.

    :param –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–æ—Ä–æ–¥ –ø–æ–∏—Å–∫–∞ –æ—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è, –≤—Ä–µ–º—è –∑–∞–∫–∞—Ç–∞, —Å–∏–ª—É –≤–µ—Ç—Ä–∞
    –í—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏
    """
    weather_token = config.weather_token  # –ø–æ–∑–¥–Ω–µ–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π

    try:
        weather_r = requests.get(f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={weather_token}"
                                 f"&units=metric", timeout=10)
        data = weather_r.json()

        city = data['name'] # –ø–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
        coord = data['coord']
        cur_w = data['main']['temp'] # —Ç–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞ –≤ –≥–æ—Ä–æ–¥–µ
        feels_like = data['main']['feels_like'] # –ø–æ–≥–æ–¥–∞ "–ø–æ-–æ—â—É—â–µ–Ω–∏—è–º"
        wind = data['wind']['speed'] # —Å–∏–ª–∞ –≤–µ—Ç—Ä–∞
        emoj = data['weather'][0]['description'] # –∑–∞–º–µ–Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–≥–æ–¥—ã –Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â—É—é —ç–º–æ–¥–∂–∏
        sunset = datetime.datetime.fromtimestamp(data['sys']['sunset'])
        current_time = datetime.datetime.now() # –≤—Ä–µ–º—è –ø–æ —á–∞—Å–∞–º –ø—Ä–æ–≥—Ä–∞–º–º—ã

        delta = datetime.timedelta(seconds=data['timezone'])
        tz = datetime.timezone(delta, str(data['timezone']))
        current_time_place = datetime.datetime.now(tz=tz)

# –≤—ã–∫–∏–Ω—É—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç
        if emoj == 'clear sky':
            emoj = 'üåû'
        elif emoj == 'rain':
            emoj = 'üåßÔ∏è'
        elif emoj == 'snow':
            emoj = '‚ùÑÔ∏è'
        else:
           # emoji == emoj
            pass
            # –î–æ–¥–µ–ª–∞—Ç—å

        mounth = {1: '—è–Ω–≤–∞—Ä—å ‚ùÑÔ∏è', 2: '—Ñ–µ–≤—Ä–∞–ª—å ‚ùÑÔ∏è', 3: '–º–∞—Ä—Ç üåº', 4: '–∞–ø—Ä–µ–ª—å üåº', 5: '–º–∞–π üåº', 6: '–∏—é–Ω—å ‚òÄÔ∏è',
                  7: '–∏—é–ª—å ‚òÄÔ∏è', 8: '–∞–≤–≥—É—Å—Ç ‚òÄÔ∏è', 9: '—Å–µ–Ω—Ç—è–±—Ä—å üçÇ', 10: '–æ–∫—Ç—è–±—Ä—å üçÇ', 11: '–Ω–æ—è–±—Ä—å üçÇ', 12: '–¥–µ–∫–∞–±—Ä—å ‚ùÑÔ∏è'}

        mess = f'''–í {city} üèôÔ∏è —Å–µ–π—á–∞—Å {mounth.get(current_time_place.month)} –º–µ—Å—è—Ü, {current_time_place.day} —á–∏—Å–ª–æ'
              \n‚è±Ô∏è{current_time_place.hour} —á–∞—Å–æ–≤, {current_time_place.minute} –º–∏–Ω—É—Ç'
              \nüå°Ô∏è{cur_w}¬∞C, –æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels_like}¬∞C. {emoj}, —Å–∏–ª–∞ –≤–µ—Ç—Ä–∞: {wind} üí®'
              \n–°–æ–ª–Ω—Ü–µ —É–π–¥–µ—Ç –∑–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç –≤ {sunset} üåá'
              \n–ù–∞–¥–µ—é—Å—å —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º, –≥–∞–≤! üê∂'''

    except Exception as exeption:
        print(exeption)
        mess = '–ü–æ–≥–æ–¥—É –Ω–µ –ø–æ–¥—Å–∫–∞–∂—É, –Ω–µ –ø–æ–Ω–∏–º–∞—é –≥–¥–µ —ç—Ç–æ—Ç –≥–æ—Ä–æ–¥ ü¶¥'

    return mess
        # https://api.openweathermap.org/data/3.0/onecall?lat={lat}&lon={lon}&exclude={part}&appid={API key}



def start_weather(city):
      # –ø–æ–∑–¥–Ω–µ–µ –±—É–¥—É –ø–æ–ª—É—á–∞—Ç—å –æ—Ç –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≥–æ—Ä–æ–¥ –∏ –¥–∞–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç –ø–æ –ø–æ–≥–æ–¥–µ\
    return get_weather(city)
